// products page script extracted from inline scripts
(function(){
  // Toast init
  if(!document.getElementById('global-toast')){
    const div=document.createElement('div');
    div.id='global-toast';
    Object.assign(div.style,{position:'fixed',top:'20px',right:'20px',zIndex:'9999',display:'flex',flexDirection:'column',gap:'8px'});
    document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(div));
  }
  function showMessage(msg,type='info',timeout=3000){
    const container=document.getElementById('global-toast');
    if(!container){ console.log(msg); return; }
    const colorMap={success:'#36B37E',error:'#FF5630',warning:'#FFAB00',info:'#165DFF'};
    const item=document.createElement('div');
    Object.assign(item.style,{minWidth:'220px',maxWidth:'360px',padding:'10px 14px',borderRadius:'8px',fontSize:'14px',boxShadow:'0 2px 6px rgba(0,0,0,0.15)',color:'#fff',background:colorMap[type]||colorMap.info,opacity:'0',transition:'opacity .25s, transform .25s',transform:'translateY(-6px)'});
    item.textContent=msg;
    container.appendChild(item);
    requestAnimationFrame(()=>{ item.style.opacity='1'; item.style.transform='translateY(0)'; });
    setTimeout(()=>{ item.style.opacity='0'; item.style.transform='translateY(-6px)'; setTimeout(()=>item.remove(),300);}, timeout);
  }
  function hideMedicineModal(){const m=document.getElementById('medicine-modal');if(m) m.classList.add('hidden');const f=document.getElementById('medicine-form');if(f){f.reset();const id=document.getElementById('medicine-id');if(id) id.value='';}const preview=document.getElementById('medicine-preview');const placeholder=document.getElementById('medicine-placeholder');if(preview&&placeholder){preview.classList.add('hidden');preview.src='';placeholder.classList.remove('hidden');}}
  function showAddMedicineModal(){const m=document.getElementById('medicine-modal');if(m) m.classList.remove('hidden');const t=document.getElementById('medicine-modal-title');if(t) t.textContent='新增药品';const f=document.getElementById('medicine-form');if(f){f.reset();const id=document.getElementById('medicine-id');if(id) id.value='';}updateExpiryRemaining();}
  function updateExpiryRemaining(){const expiryInput=document.getElementById('medicine-expiry-date');const productionInput=document.getElementById('medicine-production-date');const info=document.getElementById('expiry-remaining');if(!expiryInput||!info){return;}const val=expiryInput.value;if(!val){info.textContent='';return;}const today=new Date();today.setHours(0,0,0,0);const expiry=new Date(val);const diff=Math.floor((expiry-today)/(86400000));if(diff<0){info.textContent='已过期 '+Math.abs(diff)+' 天';info.className='text-xs mt-1 text-red-600';}else if(diff<=30){info.textContent='近效期，剩余 '+diff+' 天';info.className='text-xs mt-1 text-orange-600';}else{info.textContent='剩余 '+diff+' 天';info.className='text-xs mt-1 text-gray-500';}if(productionInput&&productionInput.value){const prod=new Date(productionInput.value);if(prod>expiry){info.textContent+=' (生产日期晚于到期日期，请核查)';info.className='text-xs mt-1 text-red-600';}}}
  let currentMedicinesPage=1, medicinesPageSize=10, totalMedicinesItems=0, allMedicinesItems=[], filteredMedicinesItems=[], totalPages=0, selectedMedicines=new Set(), inStockMedicineIds=new Set();
  document.addEventListener('DOMContentLoaded',()=>{hideMedicineModal();initMedicinesEvents();loadMedicinesData();loadInStockMedicineSet();initScrollBarAndThemeToggle();});
  function initMedicinesEvents(){const exportBtn=document.getElementById('export-medicines');exportBtn&&exportBtn.addEventListener('click',exportMedicinesData);const importBtn=document.getElementById('import-medicines');importBtn&&importBtn.addEventListener('click',()=>showMessage('导入功能待实现','info'));const applyFiltersBtn=document.getElementById('apply-filters');applyFiltersBtn&&applyFiltersBtn.addEventListener('click',applyMedicinesFilters);const resetFiltersBtn=document.getElementById('reset-filters');resetFiltersBtn&&resetFiltersBtn.addEventListener('click',resetMedicinesFilters);const pageSizeSelect=document.getElementById('page-size-select');pageSizeSelect&&pageSizeSelect.addEventListener('change',function(){medicinesPageSize=parseInt(this.value);currentMedicinesPage=1;applyMedicinesFilters();});const pageJumpBtn=document.getElementById('page-jump-btn');const pageJumpInput=document.getElementById('page-jump-input');if(pageJumpBtn&&pageJumpInput){pageJumpBtn.addEventListener('click',()=>{const target=parseInt(pageJumpInput.value);if(target&&target>=1&&target<=totalPages){changeMedicinesPage(target);pageJumpInput.value='';}else{showMessage('请输入有效的页码 1-'+totalPages,'error');}});pageJumpInput.addEventListener('keypress',e=>{if(e.key==='Enter') pageJumpBtn.click();});}const selectAll=document.getElementById('select-all');selectAll&&selectAll.addEventListener('change',function(){document.querySelectorAll('.medicine-checkbox').forEach(cb=>{cb.checked=this.checked;const id=cb.getAttribute('data-id');this.checked?selectedMedicines.add(id):selectedMedicines.delete(id);});updateSelectedCount();});const cancelBtn=document.getElementById('cancel-medicine');cancelBtn&&cancelBtn.addEventListener('click',e=>{e.preventDefault();hideMedicineModal();});const saveBtn=document.getElementById('save-medicine');saveBtn&&saveBtn.addEventListener('click',e=>{e.preventDefault();saveMedicine();});const uploadBtn=document.getElementById('upload-image-btn');uploadBtn&&uploadBtn.addEventListener('click',e=>{e.preventDefault();document.getElementById('medicine-image').click();});const imageInput=document.getElementById('medicine-image');imageInput&&imageInput.addEventListener('change',e=>{const file=e.target.files[0];if(file){if(file.size>2*1024*1024){showMessage('图片大小不能超过2MB','error');return;}const reader=new FileReader();reader.onload=ev=>{const preview=document.getElementById('medicine-preview');const placeholder=document.getElementById('medicine-placeholder');preview.src=ev.target.result;preview.classList.remove('hidden');placeholder.classList.add('hidden');};reader.readAsDataURL(file);}});const addFirstBtn=document.getElementById('add-first-medicine');addFirstBtn&&addFirstBtn.addEventListener('click',e=>{e.preventDefault();showAddMedicineModal();});document.addEventListener('keydown',e=>{if(e.key==='Escape') hideMedicineModal();});const expiryInput=document.getElementById('medicine-expiry-date');expiryInput&&expiryInput.addEventListener('change',updateExpiryRemaining);}
  async function loadInStockMedicineSet(){try{if(!window.api) return; if(window.api.inventoryAPI?.getAll){const resp=await window.api.inventoryAPI.getAll();(resp?.data||resp?.content||[]).forEach(inv=>{const id=inv.medicineId||inv.medicine_id;id&&inStockMedicineIds.add(id);});}else{const r=await fetch('/api/inventory');if(r.ok){const j=await r.json();(j?.data||j||[]).forEach(inv=>{const id=inv.medicineId||inv.medicine_id;id&&inStockMedicineIds.add(id);});}}updateMedicinesSummary();}catch(e){console.warn('加载库存集合失败',e);}}
  async function loadMedicinesData(){showMedicinesLoading();try{let medicines=[];if(window.api?.medicineAPI?.searchWithStock){const pageSize=500;const first=await window.api.medicineAPI.searchWithStock('', '', 1, pageSize);let list=first?.data||first?.content||Array.isArray(first)?first:[];const tp=first?.totalPages||first?.total_pages||1;for(let p=2;p<=tp;p++){try{const resp=await window.api.medicineAPI.searchWithStock('', '', p, pageSize);const pageItems=resp?.data||resp?.content||Array.isArray(resp)?resp:[];if(pageItems?.length) list=list.concat(pageItems);}catch(e){}}medicines=list;}else if(window.api?.medicineAPI?.getAll){const response=await window.api.medicineAPI.getAll();medicines=response?.data||response?.content||Array.isArray(response)?response:[];}else{const response=await fetch('/api/medicines');if(response.ok){const result=await response.json();medicines=result?.data||result;}}if(medicines?.length){processMedicinesData(medicines);}else{showMedicinesEmpty();}}catch(e){console.error(e);showMessage('加载药品失败:'+e.message,'error');showMedicinesEmpty();}}
  function processMedicinesData(medicines){allMedicinesItems=medicines.map(m=>({id:m.medicine_id||m.medicineId||m.id||m.approval_no||m.approvalNo||'TMP_'+Math.random().toString(36).slice(2,8),name:m.trade_name||m.tradeName||m.generic_name||m.genericName||m.name||'未知药品',genericName:m.generic_name||m.genericName||'',manufacturer:m.manufacturer||'未知厂商',spec:m.spec||m.specification||'未知规格',approvalNo:m.approval_no||m.approvalNo||'待录入',categoryId:m.category_id||m.categoryId||null,category:getCategoryFromId(m.category_id)||m.category||'otc',retailPrice:parseFloat(m.retail_price||m.retailPrice||m.price||0),memberPrice:m.member_price||m.memberPrice?parseFloat(m.member_price||m.memberPrice):null,unit:m.unit||'盒',isRx:!!(m.is_rx||m.isRx),status:m.status||m.medicineStatus||'ACTIVE',description:m.description||'',imageUrl:m.image_url||m.imageUrl||m.image||null,barcode:m.barcode||null,productionDate:m.production_date||m.productionDate||null,expiryDate:m.expiry_date||m.expiryDate||null,batchNos:m.batchNos||m.batches||[],stockQuantity:m.stockQuantity||m.currentStock||null}));updateMedicinesSummary();currentMedicinesPage=1;applyMedicinesFilters();}
  function getCategoryFromId(id){const map={1:'otc',2:'prescription',5:'chinese'};return map[Number(id)]||'otc';}
  function updateMedicinesSummary(){const total=allMedicinesItems.length;document.getElementById('total-medicines')&&(document.getElementById('total-medicines').textContent=total+' 种');}
  function showMedicinesLoading(){const body=document.getElementById('medicines-list-body');body&&body.classList.add('hidden');const l=document.getElementById('loading-medicines');l&&l.classList.remove('hidden');const e=document.getElementById('empty-medicines');e&&e.classList.add('hidden');}
  function showMedicinesEmpty(){const body=document.getElementById('medicines-list-body');body&&body.classList.add('hidden');const l=document.getElementById('loading-medicines');l&&l.classList.add('hidden');const e=document.getElementById('empty-medicines');e&&e.classList.remove('hidden');}
  function applyMedicinesFilters(){filteredMedicinesItems=[...allMedicinesItems];displayFilteredMedicinesItems();}
  function displayFilteredMedicinesItems(){const start=(currentMedicinesPage-1)*medicinesPageSize;const end=start+medicinesPageSize;const items=filteredMedicinesItems.slice(start,end);displayMedicinesItems(items);updateMedicinesPagination(filteredMedicinesItems.length);}
  function displayMedicinesItems(items){const tbody=document.getElementById('medicines-list-body');if(!tbody) return;if(!items.length){showMedicinesEmpty();return;}document.getElementById('loading-medicines').classList.add('hidden');document.getElementById('empty-medicines').classList.add('hidden');tbody.classList.remove('hidden');tbody.innerHTML=items.map(it=>`<tr data-id="${it.id}" class="hover:bg-gray-50"><td class="px-6 py-4"><input type="checkbox" class="medicine-checkbox" data-id="${it.id}"></td><td class="px-6 py-4"><div class="flex items-center"><img src="${it.imageUrl||'https://picsum.photos/40/40?random='+Math.floor(Math.random()*100)}" class="w-10 h-10 mr-3 rounded" alt=""><div><div class="text-sm font-medium">${it.name}</div><div class="text-xs text-gray-500">${it.genericName||''}</div><div class="text-xs text-gray-500">${it.manufacturer}</div><div class="text-xs text-gray-500">${it.spec} ${it.unit}</div></div></div></td><td class="px-6 py-4 text-sm">${it.approvalNo}</td><td class="px-6 py-4 text-sm">${it.isRx?'处方药':'非处方药'}</td><td class="px-6 py-4 text-sm">¥${it.retailPrice.toFixed(2)}</td><td class="px-6 py-4 text-sm">${it.memberPrice?'¥'+it.memberPrice.toFixed(2):'-'}</td><td class="px-6 py-4 text-sm"><span class="medicine-indicator medicine-active">${it.status==='ACTIVE'?'在售':'停售'}</span></td><td class="px-6 py-4 text-sm"><button class="text-primary" onclick="viewMedicineDetail && viewMedicineDetail('${it.id}')">详情</button></td></tr>`).join('');document.querySelectorAll('.medicine-checkbox').forEach(cb=>cb.addEventListener('change',function(){const id=this.getAttribute('data-id');this.checked?selectedMedicines.add(id):selectedMedicines.delete(id);}));}
  function updateMedicinesPagination(total){totalMedicinesItems=total;totalPages=Math.ceil(total/medicinesPageSize);document.getElementById('medicines-total-text')&&(document.getElementById('medicines-total-text').textContent='共 '+total+' 种药品');const range=document.getElementById('medicines-range-text');if(range){const start=(total?((currentMedicinesPage-1)*medicinesPageSize+1):0);const end=Math.min(currentMedicinesPage*medicinesPageSize,total);range.textContent='显示 '+start+'-'+end+' 条，共 '+total+' 条';}const container=document.getElementById('medicines-pagination-controls');if(!container) return;container.innerHTML='';for(let i=1;i<=totalPages;i++){const btn=document.createElement('button');btn.className='pagination-btn'+(i===currentMedicinesPage?' active':'');btn.textContent=i;btn.onclick=()=>changeMedicinesPage(i);container.appendChild(btn);} }
  function changeMedicinesPage(p){if(p<1||p>totalPages) return;currentMedicinesPage=p;displayFilteredMedicinesItems();}
  function exportMedicinesData(){try{const data=filteredMedicinesItems.length?filteredMedicinesItems:allMedicinesItems;let csv='\uFEFF名称,规格,厂家,零售价\n';data.forEach(d=>{csv+=`${d.name},${d.spec},${d.manufacturer},${d.retailPrice}\n`;});const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='药品导出.csv';document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),200);showMessage('导出成功','success');}catch(e){showMessage('导出失败:'+e.message,'error');}}
  function resetMedicinesFilters(){currentMedicinesPage=1;applyMedicinesFilters();showMessage('筛选已重置','info');}
  function saveMedicine(){showMessage('保存逻辑待实现','info');}
  function initScrollBarAndThemeToggle(){const bar=document.getElementById('scroll-progress');function update(){const h=document.documentElement.scrollHeight-window.innerHeight;const sc=window.scrollY;bar&&(bar.style.width=(h>0?(sc/h)*100:0)+'%');}window.addEventListener('scroll',update,{passive:true});update();if(!document.getElementById('theme-toggle')){const btn=document.createElement('button');btn.id='theme-toggle';btn.className='theme-toggle';btn.innerHTML='<i class="fa fa-moon-o"></i>';btn.onclick=()=>{const dark=document.documentElement.classList.toggle('dark');btn.innerHTML='<i class="fa '+(dark?'fa-sun-o':'fa-moon-o')+'"></i>';};document.body.appendChild(btn);}}
  // expose some functions if needed
  window.showMessage=showMessage;
})();

