<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧药房收银系统 - 历史订单</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="js/common.js"></script>

    <!-- 配置Tailwind -->
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                primary: '#165DFF',
                secondary: '#36B37E',
                accent: '#FF5630',
              },
              fontFamily: {
                inter: ['Inter', 'system-ui', 'sans-serif'],
              },
            },
          }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
          .sidebar-item {
            @apply flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer;
          }
          .sidebar-item.active {
            @apply bg-primary text-white;
          }
          .sidebar-item:not(.active):hover {
            @apply bg-gray-100;
          }
          .card {
            @apply bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 hover:shadow-md;
          }
          .btn {
            @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2;
          }
          .btn-primary {
            @apply bg-primary text-white hover:bg-primary/90;
          }
          .btn-outline {
            @apply border border-gray-300 hover:bg-gray-50;
          }
          .btn-danger {
            @apply bg-accent text-white hover:bg-accent/90;
          }
          .input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all;
          }
          .badge {
            @apply px-2 py-1 rounded-full text-xs font-medium;
          }

          /* 滚动条样式 */
          .main-content {
            @apply flex-1 p-6 bg-gray-50;
            height: calc(100vh - 64px);
            overflow-y: scroll;
            scrollbar-width: thin;
          }
          .main-content::-webkit-scrollbar {
            width: 8px;
          }
          .main-content::-webkit-scrollbar-track {
            background: #f5f5f5;
            border-radius: 4px;
          }
          .main-content::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
          }
        }
    </style>
</head>

<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex">
<!-- 侧边栏 -->
<aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col h-screen z-10">
    <div class="p-4 border-b border-gray-200">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                <i class="fa fa-medkit text-primary"></i>
            </div>
            <h1 class="font-bold text-lg">智慧药房系统</h1>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto py-4 px-3">
        <nav class="space-y-1">
            <p class="text-xs font-medium text-gray-500 px-4 mb-2">主功能</p>
            <a href="medicine-management.html" class="sidebar-item block">
                <i class="fa fa-dashboard w-5 text-center"></i>
                <span>控制台</span>
            </a>
            <a href="cashier.html" class="sidebar-item block">
                <i class="fa fa-shopping-cart w-5 text-center"></i>
                <span>收银管理</span>
            </a>
            <a href="order-history.html" class="sidebar-item active block">
                <i class="fa fa-history w-5 text-center"></i>
                <span>历史订单</span>
            </a>
            <a href="stock-in.html" class="sidebar-item block">
                <i class="fa fa-box w-5 text-center"></i>
                <span>药品入库</span>
            </a>
            <a href="inventory.html" class="sidebar-item block">
                <i class="fa fa-warehouse w-5 text-center"></i>
                <span>库存管理</span>
            </a>
            <a href="members.html" class="sidebar-item block">
                <i class="fa fa-users w-5 text-center"></i>
                <span>会员管理</span>
            </a>
        </nav>
    </div>

    <div class="p-4 border-t border-gray-200">
        <div class="flex items-center gap-3">
            <img src="https://picsum.photos/200/200?random=1" alt="用户头像" class="w-10 h-10 rounded-full object-cover">
            <div>
                <p class="font-medium text-sm">张药师</p>
                <p class="text-xs text-gray-500">管理员</p>
            </div>
            <a href="login.html" class="ml-auto text-gray-400 hover:text-accent transition-colors">
                <i class="fa fa-sign-out"></i>
            </a>
        </div>
    </div>
</aside>

<!-- 主内容区 -->
<main class="flex-1 flex flex-col">
    <!-- 顶部导航 -->
    <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6">
        <div class="flex items-center gap-4">
            <button id="sidebar-toggle" class="lg:hidden text-gray-500 hover:text-primary">
                <i class="fa fa-bars text-xl"></i>
            </button>
            <div class="relative">
                <input type="text" placeholder="搜索订单号、会员..." class="w-64 px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all" id="global-search">
                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <button class="relative p-2 text-gray-500 hover:text-primary hover:bg-gray-100 rounded-full transition-colors">
                <i class="fa fa-bell text-xl"></i>
                <span class="absolute top-1 right-1 w-2 h-2 bg-accent rounded-full"></span>
            </button>

            <div class="text-right hidden md:block">
                <p class="text-sm font-medium">今天 <span id="current-date"></span></p>
                <p class="text-xs text-gray-500" id="current-time"></p>
            </div>
        </div>
    </header>

    <!-- 可滚动内容区 -->
    <div class="main-content">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
            <div>
                <h2 class="text-[clamp(1.25rem,2vw,1.75rem)] font-bold">历史订单</h2>
                <p class="text-gray-500">查看所有已完成订单记录</p>
            </div>
            <div class="flex gap-3">
                <button class="btn btn-outline" id="export-orders-btn">
                    <i class="fa fa-download"></i> 导出订单
                </button>
                <button class="btn btn-primary" id="refresh-orders-btn">
                    <i class="fa fa-refresh"></i> 刷新数据
                </button>
            </div>
        </div>

        <!-- 订单筛选 -->
        <div class="card p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">订单日期</label>
                    <input type="date" class="input" id="order-date-filter">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">订单状态</label>
                    <select class="input" id="order-status-filter">
                        <option value="">全部状态</option>
                        <option value="1">已支付</option>
                        <option value="2">已退款</option>
                        <option value="0">待支付</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">支付方式</label>
                    <select class="input" id="payment-type-filter">
                        <option value="">全部方式</option>
                        <option value="1">现金</option>
                        <option value="2">微信</option>
                        <option value="3">支付宝</option>
                        <option value="4">医保</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">会员信息</label>
                    <input type="text" class="input" placeholder="会员姓名或手机号" id="member-filter">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button class="btn btn-outline" id="reset-filters-btn">重置</button>
                <button class="btn btn-primary" id="apply-filters-btn">查询</button>
            </div>
        </div>

        <!-- 订单列表 -->
        <div class="card">
            <div class="p-6 border-b border-gray-100">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold">订单列表</h3>
                    <div class="text-sm text-gray-500" id="orders-count">共 0 条订单</div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">订单信息</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">会员信息</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">支付信息</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">订单金额</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="orders-list-body">
                    <!-- 订单数据将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>

            <!-- 加载状态 -->
            <div id="loading-orders" class="hidden text-center py-8">
                <i class="fa fa-spinner fa-spin text-2xl text-primary mb-2"></i>
                <p class="text-gray-500">加载中...</p>
            </div>

            <!-- 空状态 -->
            <div id="empty-orders" class="hidden text-center py-12">
                <i class="fa fa-file-text-o text-4xl text-gray-300 mb-3"></i>
                <p class="text-gray-500">暂无订单数据</p>
                <p class="text-sm text-gray-400 mt-1">请尝试其他筛选条件</p>
            </div>

            <!-- 分页部分 -->
            <div class="p-4 border-t border-gray-100 flex justify-between items-center">
                <div class="text-sm text-gray-500" id="orders-pagination-info">显示 0-0 条，共 0 条</div>
                <div class="flex gap-1" id="orders-pagination-controls">
                    <!-- 分页控件将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 订单详情模态框 -->
<div id="order-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <h3 class="font-bold text-lg mb-4">订单详情</h3>
        <div id="order-detail-content">
            <!-- 订单详情内容将通过JavaScript动态加载 -->
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button class="btn btn-outline" id="close-order-detail">关闭</button>
            <button class="btn btn-primary" id="print-order-btn">
                <i class="fa fa-print"></i> 打印订单
            </button>
            <button class="btn btn-danger hidden" id="refund-order-btn">
                <i class="fa fa-undo"></i> 退单
            </button>
        </div>
    </div>
</div>

<!-- 退单确认模态框 -->
<div id="refund-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
        <h3 class="font-bold text-lg mb-4">确认退单</h3>
        <div class="mb-6">
            <p class="text-gray-700 mb-2">您确定要对此订单执行退单操作吗？</p>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-start">
                    <i class="fa fa-exclamation-triangle text-yellow-500 mt-1 mr-2"></i>
                    <div>
                        <p class="text-sm text-yellow-700 font-medium">退单注意事项</p>
                        <ul class="text-xs text-yellow-600 mt-1 list-disc pl-4">
                            <li>退单后，订单状态将变为"已退款"</li>
                            <li>如果是会员订单，使用的积分将返还给会员</li>
                            <li>已获得的积分将从会员账户中扣除</li>
                            <li>此操作不可撤销，请谨慎操作</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <label for="refund-reason" class="block text-sm font-medium text-gray-700 mb-1">退单原因（可选）</label>
                <textarea id="refund-reason" class="input h-20" placeholder="请输入退单原因..."></textarea>
            </div>
        </div>
        <div class="flex justify-end gap-3">
            <button class="btn btn-outline" id="cancel-refund-btn">取消</button>
            <button class="btn btn-danger" id="confirm-refund-btn">
                <i class="fa fa-undo"></i> 确认退单
            </button>
        </div>
    </div>
</div>

<script>
    // 全局变量
    let currentOrdersPage = 1;
    const ordersPageSize = 10;
    let totalOrders = 0;
    let allOrders = [];
    let filteredOrders = [];
    let currentOrderDetail = null; // 当前查看详情的订单

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        initDateTime();
        initSidebar();
        initOrderEvents();
        loadOrders();
    });

    // 日期时间初始化
    function initDateTime() {
        const update = () => {
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('zh-CN', {month:'long', day:'numeric', weekday:'long'});
            document.getElementById('current-time').textContent = now.toLocaleTimeString('zh-CN');
        };
        update();
        setInterval(update, 1000);
    }

    // 侧边栏切换
    function initSidebar() {
        document.getElementById('sidebar-toggle')?.addEventListener('click', () => {
            const sidebar = document.querySelector('aside');
            sidebar.classList.toggle('w-64');
            sidebar.classList.toggle('w-0');
            sidebar.classList.toggle('hidden');
        });
    }

    // ========== 打印功能 - 移到前面 ==========
    function printOrder() {
        if (!currentOrderDetail) {
            showMessage('没有可打印的订单数据', 'error');
            return;
        }

        // 创建打印内容
        const printContent = generatePrintContent(currentOrderDetail);

        // 创建打印窗口
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>打印订单 - ${currentOrderDetail.orderId}</title>
                <style>
                    body {
                        font-family: 'Microsoft YaHei', Arial, sans-serif;
                        margin: 20px;
                        color: #333;
                    }
                    .print-header {
                        text-align: center;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #333;
                        padding-bottom: 10px;
                    }
                    .print-header h1 {
                        margin: 0;
                        font-size: 24px;
                        color: #165DFF;
                    }
                    .print-header .subtitle {
                        font-size: 14px;
                        color: #666;
                    }
                    .order-info {
                        margin-bottom: 20px;
                    }
                    .info-section {
                        margin-bottom: 15px;
                    }
                    .info-section h3 {
                        margin: 0 0 10px 0;
                        font-size: 16px;
                        color: #165DFF;
                        border-bottom: 1px solid #eee;
                        padding-bottom: 5px;
                    }
                    .info-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 10px;
                    }
                    .info-item {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 5px;
                    }
                    .info-label {
                        font-weight: bold;
                        color: #666;
                    }
                    .info-value {
                        text-align: right;
                    }
                    .amount-section {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 5px;
                        margin: 20px 0;
                    }
                    .amount-row {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 8px;
                    }
                    .total-row {
                        font-weight: bold;
                        font-size: 18px;
                        border-top: 2px solid #333;
                        padding-top: 10px;
                        margin-top: 10px;
                    }
                    .footer {
                        text-align: center;
                        margin-top: 30px;
                        font-size: 12px;
                        color: #999;
                        border-top: 1px solid #eee;
                        padding-top: 10px;
                    }
                    @media print {
                        body { margin: 0; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                ${printContent}
                <div class="footer">
                    <p>感谢您的惠顾！</p>
                    <p>打印时间：${new Date().toLocaleString('zh-CN')}</p>
                </div>
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(() => {
                            window.close();
                        }, 500);
                    }
                <\/script>
            </body>
            </html>
        `);
        printWindow.document.close();
    }

    function generatePrintContent(order) {
        // 计算折扣金额
        let discountAmount = order.discountAmount || 0;
        let originalAmount = order.totalAmount || 0;
        let actualPayment = order.actualPayment || order.totalAmount || 0;

        if (order.actualPayment && order.totalAmount && order.actualPayment !== order.totalAmount) {
            discountAmount = order.totalAmount - order.actualPayment;
            originalAmount = order.totalAmount;
        }

        return `
            <div class="print-header">
                <h1>智慧药房 - 销售订单</h1>
                <div class="subtitle">PHARMACY SALES ORDER</div>
            </div>

            <div class="order-info">
                <div class="info-section">
                    <h3>订单基本信息</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">订单号：</span>
                            <span class="info-value">${order.orderId}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">下单时间：</span>
                            <span class="info-value">${formatDateTime(order.orderTime)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">支付时间：</span>
                            <span class="info-value">${order.payTime ? formatDateTime(order.payTime) : '未支付'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">收银员：</span>
                            <span class="info-value">${order.cashierId || '未知'}</span>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>客户信息</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">客户姓名：</span>
                            <span class="info-value">${order.customerName || '匿名客户'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">会员状态：</span>
                            <span class="info-value">${order.memberId ? '会员' : '非会员'}</span>
                        </div>
                        ${order.memberId ? `
                        <div class="info-item">
                            <span class="info-label">会员ID：</span>
                            <span class="info-value">${order.memberId}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <div class="info-section">
                    <h3>支付信息</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">支付方式：</span>
                            <span class="info-value">${getPaymentTypeText(order.paymentType)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">支付状态：</span>
                            <span class="info-value">${getPaymentStatusText(order.paymentStatus)}</span>
                        </div>
                        ${order.refundTime ? `
                        <div class="info-item">
                            <span class="info-label">退款时间：</span>
                            <span class="info-value">${formatDateTime(order.refundTime)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">退款原因：</span>
                            <span class="info-value">${order.refundReason || '无'}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <div class="amount-section">
                    <div class="amount-row">
                        <span>订单总额：</span>
                        <span>${formatPrice(originalAmount)}</span>
                    </div>
                    ${discountAmount > 0 ? `
                    <div class="amount-row">
                        <span>优惠金额：</span>
                        <span style="color: #36B37E;">-${formatPrice(discountAmount)}</span>
                    </div>
                    ` : ''}
                    <div class="amount-row total-row">
                        <span>实付金额：</span>
                        <span style="color: #165DFF; font-weight: bold;">${formatPrice(actualPayment)}</span>
                    </div>
                </div>

                ${order.memberId ? `
                <div class="info-section">
                    <h3>会员积分</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">使用积分：</span>
                            <span class="info-value">${order.usedPoints || 0} 积分</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">获得积分：</span>
                            <span class="info-value">${order.createdPoints || 0} 积分</span>
                        </div>
                    </div>
                </div>
                ` : ''}

                <div class="info-section">
                    <h3>温馨提示</h3>
                    <div style="font-size: 12px; color: #666; line-height: 1.5;">
                        <p>• 请妥善保管本订单，作为购买凭证</p>
                        <p>• 药品使用请遵医嘱，仔细阅读说明书</p>
                        <p>• 如有质量问题，请凭本单7日内退换</p>
                        <p>• 咨询电话：400-123-4567</p>
                    </div>
                </div>
            </div>
        `;
    }

    // 订单相关事件初始化
    function initOrderEvents() {
        document.getElementById('refresh-orders-btn').addEventListener('click', loadOrders);
        document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
        document.getElementById('reset-filters-btn').addEventListener('click', resetFilters);
        document.getElementById('global-search').addEventListener('input', function() {
            currentOrdersPage = 1;
            applyFilters();
        });
        document.getElementById('close-order-detail').addEventListener('click', function() {
            document.getElementById('order-detail-modal').classList.add('hidden');
        });
        document.getElementById('export-orders-btn').addEventListener('click', exportOrders);
        document.getElementById('order-date-filter').addEventListener('change', function() {
            currentOrdersPage = 1;
            applyFilters();
        });
        document.getElementById('order-status-filter').addEventListener('change', function() {
            currentOrdersPage = 1;
            applyFilters();
        });
        document.getElementById('payment-type-filter').addEventListener('change', function() {
            currentOrdersPage = 1;
            applyFilters();
        });
        document.getElementById('member-filter').addEventListener('input', function() {
            currentOrdersPage = 1;
            applyFilters();
        });

        // 退单相关事件
        document.getElementById('refund-order-btn').addEventListener('click', function() {
            showRefundConfirmModal();
        });
        document.getElementById('cancel-refund-btn').addEventListener('click', function() {
            document.getElementById('refund-confirm-modal').classList.add('hidden');
        });
        document.getElementById('confirm-refund-btn').addEventListener('click', processRefund);

        // ✅ 打印订单事件监听 - 修复：放在函数内部
        document.getElementById('print-order-btn').addEventListener('click', printOrder);

    }

    // 重置筛选
    function resetFilters() {
        document.getElementById('order-date-filter').value = '';
        document.getElementById('order-status-filter').value = '';
        document.getElementById('payment-type-filter').value = '';
        document.getElementById('member-filter').value = '';
        document.getElementById('global-search').value = '';
        currentOrdersPage = 1;
        applyFilters();
    }

    // 加载订单数据
    async function loadOrders() {
        console.log('=== 开始加载订单数据 ===');
        showOrdersLoading();

        try {
            const response = await fetch(`http://localhost:8080/api/orders?page=0&size=1000`);
            console.log('API响应状态:', response.status);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log('完整的API响应:', result);

            if (result && result.code === 200) {
                console.log('获取到订单数据:', result.data);
                allOrders = result.data || [];
                console.log('存储所有订单:', allOrders.length, '条');

                currentOrdersPage = 1;
                applyFilters();
            } else {
                console.log('API返回错误:', result.message);
                showOrdersEmpty();
            }
        } catch (error) {
            console.error('加载订单失败:', error);
            showOrdersEmpty();
            showMessage('加载订单失败: ' + error.message, 'error');
        }
    }

    // 应用筛选条件
    function applyFilters() {
        console.log('=== 应用筛选条件 ===');

        if (allOrders.length === 0) {
            console.log('没有订单数据可筛选');
            showOrdersEmpty();
            return;
        }

        const filters = getOrderFilters();
        console.log('筛选条件:', filters);

        filteredOrders = [...allOrders];

        // 日期筛选
        if (filters.date) {
            console.log('执行日期筛选，目标日期:', filters.date);
            filteredOrders = filteredOrders.filter(order => {
                if (!order.orderTime) {
                    console.log('订单没有orderTime', order);
                    return false;
                }
                const orderDate = new Date(order.orderTime).toISOString().split('T')[0];
                console.log(`比较日期: 订单日期=${orderDate}, 筛选日期=${filters.date}, 是否匹配=${orderDate === filters.date}`);
                return orderDate === filters.date;
            });
            console.log('日期筛选后订单数量:', filteredOrders.length);
        }

        // 状态筛选
        if (filters.status) {
            filteredOrders = filteredOrders.filter(order =>
                order.paymentStatus && order.paymentStatus.toString() === filters.status
            );
        }

        // 支付方式筛选
        if (filters.paymentType) {
            filteredOrders = filteredOrders.filter(order =>
                order.paymentType && order.paymentType.toString() === filters.paymentType
            );
        }

        // 会员信息筛选
        if (filters.member) {
            const searchTerm = filters.member.toLowerCase();
            filteredOrders = filteredOrders.filter(order =>
                (order.customerName && order.customerName.toLowerCase().includes(searchTerm)) ||
                (order.memberId && order.memberId.toLowerCase().includes(searchTerm))
            );
        }

        // 全局搜索
        if (filters.globalSearch) {
            const searchTerm = filters.globalSearch.toLowerCase();
            filteredOrders = filteredOrders.filter(order =>
                (order.orderId && order.orderId.toLowerCase().includes(searchTerm)) ||
                (order.customerName && order.customerName.toLowerCase().includes(searchTerm)) ||
                (order.memberId && order.memberId.toLowerCase().includes(searchTerm))
            );
        }

        console.log('筛选后订单数量:', filteredOrders.length);
        displayFilteredOrders();
    }

    // 获取筛选条件
    function getOrderFilters() {
        return {
            date: document.getElementById('order-date-filter').value,
            status: document.getElementById('order-status-filter').value,
            paymentType: document.getElementById('payment-type-filter').value,
            member: document.getElementById('member-filter').value,
            globalSearch: document.getElementById('global-search').value
        };
    }

    // 显示筛选后的订单
    function displayFilteredOrders() {
        const startIndex = (currentOrdersPage - 1) * ordersPageSize;
        const endIndex = startIndex + ordersPageSize;
        const pagedOrders = filteredOrders.slice(startIndex, endIndex);

        console.log('分页后订单:', pagedOrders);
        displayOrders(pagedOrders);
        updateOrdersPagination(filteredOrders.length);
    }

    // 显示订单加载状态
    function showOrdersLoading() {
        document.getElementById('orders-list-body').classList.add('hidden');
        document.getElementById('loading-orders').classList.remove('hidden');
        document.getElementById('empty-orders').classList.add('hidden');
    }

    // 显示订单空状态
    function showOrdersEmpty() {
        document.getElementById('orders-list-body').classList.add('hidden');
        document.getElementById('loading-orders').classList.add('hidden');
        document.getElementById('empty-orders').classList.remove('hidden');
        document.getElementById('orders-count').textContent = '共 0 条订单';
        document.getElementById('orders-pagination-info').textContent = '显示 0-0 条，共 0 条';
        document.getElementById('orders-pagination-controls').innerHTML = '';
    }

    // 显示订单数据 - 关键修复：重新计算折扣
    function displayOrders(orders) {
        const tbody = document.getElementById('orders-list-body');

        console.log('要显示的订单数据:', orders);

        if (!orders || orders.length === 0) {
            console.log('没有订单数据，显示空状态');
            showOrdersEmpty();
            return;
        }

        document.getElementById('loading-orders').classList.add('hidden');
        document.getElementById('empty-orders').classList.add('hidden');
        tbody.classList.remove('hidden');

        const html = orders.map(order => {
            console.log('处理订单:', order);

            // ========== 关键修复：重新计算折扣 ==========
            // 由于后端没有正确保存折扣信息，我们需要重新计算
            let discountAmount = order.discountAmount || 0;
            let originalAmount = order.totalAmount || 0;
            let actualPayment = order.actualPayment || order.totalAmount || 0;

            // 如果有实际支付金额且与总金额不同，重新计算折扣
            // 注意：根据您的日志，后端返回的totalAmount实际上是原价，actualPayment是折后价
            if (order.actualPayment && order.totalAmount && order.actualPayment !== order.totalAmount) {
                discountAmount = order.totalAmount - order.actualPayment;
                originalAmount = order.totalAmount;
            } else if (order.memberId && order.discountAmount === 0) {
                // 如果是会员订单但没有折扣信息，显示会员折扣（但金额为0）
                discountAmount = 0; // 无法计算具体折扣金额
            }
            // ========== 折扣计算逻辑结束 ==========

            return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4">
                        <div>
                            <div class="text-sm font-medium">${order.orderId || '未知订单'}</div>
                            <div class="text-xs text-gray-500">${order.orderTime ? formatDateTime(order.orderTime) : '未知时间'}</div>
                            <div class="text-xs text-gray-500">收银员: ${order.cashierId || '未知'}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        ${order.customerName ? `
                            <div class="text-sm font-medium">${order.customerName}</div>
                            <div class="text-xs text-gray-500">${order.memberId ? '会员' : '非会员'}</div>
                        ` : '<div class="text-sm text-gray-500">匿名客户</div>'}
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm">${getPaymentTypeText(order.paymentType)}</div>
                        <div class="text-xs text-gray-500">${getPaymentStatusText(order.paymentStatus)}</div>
                        ${order.payTime ? `<div class="text-xs text-gray-500">${formatDateTime(order.payTime)}</div>` : ''}
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium">${formatPrice(actualPayment)}</div>
                        ${discountAmount > 0 ? `<div class="text-xs text-secondary">优惠: -${formatPrice(discountAmount)}</div>` : ''}
                        ${order.memberId && discountAmount === 0 ? `<div class="text-xs text-green-600">会员订单</div>` : ''}
                    </td>
                    <td class="px-6 py-4">
                        <button class="btn btn-outline text-sm px-3 py-1 view-order-detail" data-order-id="${order.orderId}">
                            <i class="fa fa-eye"></i> 查看详情
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = html;

        // 重新绑定查看详情事件
        document.querySelectorAll('.view-order-detail').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                showOrderDetail(orderId);
            });
        });
    }

    // 更新订单分页信息
    function updateOrdersPagination(total) {
        totalOrders = total;
        const totalPages = Math.ceil(total / ordersPageSize);

        const startItem = ((currentOrdersPage - 1) * ordersPageSize) + 1;
        const endItem = Math.min(currentOrdersPage * ordersPageSize, total);

        document.getElementById('orders-count').textContent = `共 ${total} 条订单`;
        document.getElementById('orders-pagination-info').textContent =
            `显示 ${startItem}-${endItem} 条，共 ${total} 条`;

        updateOrdersPaginationControls(totalPages);
    }

    // 更新订单分页控件
    function updateOrdersPaginationControls(totalPages) {
        const container = document.getElementById('orders-pagination-controls');

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '';

        // 上一页按钮
        if (currentOrdersPage > 1) {
            html += `
                <button class="w-8 h-8 flex items-center justify-center rounded border border-gray-300 hover:bg-gray-50 transition-colors"
                        onclick="changeOrdersPage(${currentOrdersPage - 1})">
                    <i class="fa fa-chevron-left text-xs"></i>
                </button>
            `;
        } else {
            html += `
                <button class="w-8 h-8 flex items-center justify-center rounded border border-gray-300 text-gray-400 cursor-not-allowed" disabled>
                    <i class="fa fa-chevron-left text-xs"></i>
                </button>
            `;
        }

        // 页码按钮
        const startPage = Math.max(1, currentOrdersPage - 2);
        const endPage = Math.min(totalPages, startPage + 4);

        for (let i = startPage; i <= endPage; i++) {
            if (i === currentOrdersPage) {
                html += `
                    <button class="w-8 h-8 flex items-center justify-center rounded border border-primary bg-primary text-white">
                        ${i}
                    </button>
                `;
            } else {
                html += `
                    <button class="w-8 h-8 flex items-center justify-center rounded border border-gray-300 hover:bg-gray-50 transition-colors"
                            onclick="changeOrdersPage(${i})">
                        ${i}
                    </button>
                `;
            }
        }

        // 下一页按钮
        if (currentOrdersPage < totalPages) {
            html += `
                <button class="w-8 h-8 flex items-center justify-center rounded border border-gray-300 hover:bg-gray-50 transition-colors"
                        onclick="changeOrdersPage(${currentOrdersPage + 1})">
                    <i class="fa fa-chevron-right text-xs"></i>
                </button>
            `;
        } else {
            html += `
                <button class="w-8 h-8 flex items-center justify-center rounded border border-gray-300 text-gray-400 cursor-not-allowed" disabled>
                    <i class="fa fa-chevron-right text-xs"></i>
                </button>
            `;
        }

        container.innerHTML = html;
    }

    // 切换订单页面
    function changeOrdersPage(page) {
        console.log('切换订单页面到:', page);

        const totalPages = Math.ceil(filteredOrders.length / ordersPageSize);

        if (page < 1 || page > totalPages) {
            console.log('无效的页码:', page);
            return;
        }

        currentOrdersPage = page;
        displayFilteredOrders();
    }

    // 显示订单详情
    async function showOrderDetail(orderId) {
        try {
            const response = await fetch(`http://localhost:8080/api/orders/${orderId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();

            if (result && result.code === 200) {
                currentOrderDetail = result.data;
                displayOrderDetail(result.data);
                document.getElementById('order-detail-modal').classList.remove('hidden');
            } else {
                throw new Error(result.message || '获取订单详情失败');
            }
        } catch (error) {
            console.error('获取订单详情失败:', error);
            showMessage('获取订单详情失败: ' + error.message, 'error');
        }
    }

    // 显示订单详情内容 - 关键修复：重新计算折扣
    function displayOrderDetail(order) {
        const container = document.getElementById('order-detail-content');

        // ========== 关键修复：重新计算折扣 ==========
        let discountAmount = order.discountAmount || 0;
        let originalAmount = order.totalAmount || 0;
        let actualPayment = order.actualPayment || order.totalAmount || 0;

        // 如果有实际支付金额且与总金额不同，重新计算折扣
        if (order.actualPayment && order.totalAmount && order.actualPayment !== order.totalAmount) {
            discountAmount = order.totalAmount - order.actualPayment;
            originalAmount = order.totalAmount;
        }
        // ========== 折扣计算逻辑结束 ==========

        const html = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <h4 class="font-medium mb-2">订单基本信息</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">订单号:</span>
                            <span>${order.orderId}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">下单时间:</span>
                            <span>${formatDateTime(order.orderTime)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">支付时间:</span>
                            <span>${order.payTime ? formatDateTime(order.payTime) : '未支付'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">收银员:</span>
                            <span>${order.cashierId || '未知'}</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="font-medium mb-2">支付信息</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">支付方式:</span>
                            <span>${getPaymentTypeText(order.paymentType)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">支付状态:</span>
                            <span class="${getPaymentStatusClass(order.paymentStatus)}">${getPaymentStatusText(order.paymentStatus)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">订单总额:</span>
                            <span>${formatPrice(originalAmount)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">优惠金额:</span>
                            <span class="text-secondary">-${formatPrice(discountAmount)}</span>
                        </div>
                        <div class="flex justify-between font-medium border-t pt-2">
                            <span>实付金额:</span>
                            <span class="text-primary">${formatPrice(actualPayment)}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="font-medium mb-2">会员信息</h4>
                ${order.memberId ? `
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">会员ID:</span>
                            <span>${order.memberId}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">使用积分:</span>
                            <span>${order.usedPoints || 0} 积分</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">获得积分:</span>
                            <span>${order.createdPoints || 0} 积分</span>
                        </div>
                    </div>
                ` : '<div class="text-sm text-gray-500">非会员订单</div>'}
            </div>

            <div>
                <h4 class="font-medium mb-2">订单商品</h4>
                <div class="text-sm text-gray-500">
                    商品详情功能需要后端支持，请联系开发人员添加订单项查询接口。
                </div>
            </div>
        `;

        container.innerHTML = html;

        // 根据订单状态显示或隐藏退单按钮
        const refundBtn = document.getElementById('refund-order-btn');
        if (order.paymentStatus === 1) { // 只有已支付的订单可以退单
            refundBtn.classList.remove('hidden');
        } else {
            refundBtn.classList.add('hidden');
        }
    }

    // 显示退单确认模态框
    function showRefundConfirmModal() {
        document.getElementById('refund-confirm-modal').classList.remove('hidden');
    }

    // 处理退单请求
    async function processRefund() {
        const refundBtn = document.getElementById('confirm-refund-btn');
        const originalHTML = refundBtn.innerHTML;

        try {
            refundBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 处理中...';
            refundBtn.disabled = true;

            const refundReason = document.getElementById('refund-reason').value;

            // 调用退单API
            const response = await fetch(`http://localhost:8080/api/orders/${currentOrderDetail.orderId}/refund`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reason: refundReason || '无'
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result && result.code === 200) {
                // 退单成功
                showMessage('退单成功', 'success');
                document.getElementById('refund-confirm-modal').classList.add('hidden');
                document.getElementById('order-detail-modal').classList.add('hidden');

                // 刷新订单列表
                loadOrders();
            } else {
                throw new Error(result.message || '退单失败');
            }
        } catch (error) {
            console.error('退单失败:', error);
            showMessage('退单失败: ' + error.message, 'error');
        } finally {
            refundBtn.innerHTML = originalHTML;
            refundBtn.disabled = false;
        }
    }

    // 修复导出订单函数 - 使用更稳定的CSV导出
    async function exportOrders() {
        const btn = document.getElementById('export-orders-btn');
        if (!btn) {
            console.error('导出按钮未找到');
            return;
        }

        const originalHTML = btn.innerHTML;

        try {
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 导出中...';
            btn.disabled = true;

            const ordersToExport = filteredOrders.length > 0 ? filteredOrders : allOrders;

            console.log('准备导出的订单数量:', ordersToExport.length);

            if (ordersToExport.length === 0) {
                showMessage('没有订单数据可导出', 'warning');
                return;
            }

            // 使用更稳定的CSV导出方法
            const csvData = convertOrdersToCSV(ordersToExport);
            downloadFile(csvData, `订单数据_${getCurrentDate()}.csv`, 'text/csv;charset=utf-8;');

            showMessage(`成功导出 ${ordersToExport.length} 条订单数据`, 'success');

        } catch (error) {
            console.error('导出订单失败:', error);
            showMessage('导出订单失败: ' + error.message, 'error');
        } finally {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }
    }

    // 更稳定的CSV转换函数
    function convertOrdersToCSV(orders) {
        const headers = [
            '订单号', '下单时间', '收银员ID', '会员ID',
            '客户姓名', '订单总额', '实付金额', '优惠金额',
            '支付状态', '支付方式', '支付时间', '使用积分', '获得积分'
        ];

        // CSV头部
        let csvContent = '\uFEFF' + headers.join(',') + '\n';

        // 数据行
        orders.forEach(order => {
            // 计算折扣金额
            let discountAmount = order.discountAmount || 0;
            if (order.actualPayment && order.totalAmount && order.actualPayment !== order.totalAmount) {
                discountAmount = order.totalAmount - order.actualPayment;
            }

            const row = [
                escapeCSVField(order.orderId || ''),
                escapeCSVField(order.orderTime ? formatDateTime(order.orderTime) : ''),
                escapeCSVField(order.cashierId || ''),
                escapeCSVField(order.memberId || ''),
                escapeCSVField(order.customerName || ''),
                order.totalAmount || 0,
                order.actualPayment || order.totalAmount || 0,
                discountAmount,
                escapeCSVField(getPaymentStatusText(order.paymentStatus)),
                escapeCSVField(getPaymentTypeText(order.paymentType)),
                escapeCSVField(order.payTime ? formatDateTime(order.payTime) : ''),
                order.usedPoints || 0,
                order.createdPoints || 0
            ];

            csvContent += row.join(',') + '\n';
        });

        return csvContent;
    }

    // CSV字段转义函数
    function escapeCSVField(field) {
        if (field === null || field === undefined) return '""';

        const stringField = String(field);

        // 如果包含逗号、换行符或引号，需要用引号包围并转义内部引号
        if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
            return '"' + stringField.replace(/"/g, '""') + '"';
        }

        return stringField;
    }

    // 通用文件下载函数
    function downloadFile(data, filename, mimeType) {
        const blob = new Blob([data], { type: mimeType });
        const url = URL.createObjectURL(blob);

        const link = document.createElement('a');
        link.href = url;
        link.download = filename;

        // 兼容不同浏览器的下载方式
        if (document.createEvent) {
            const event = document.createEvent('MouseEvents');
            event.initEvent('click', true, true);
            link.dispatchEvent(event);
        } else {
            link.click();
        }

        // 清理URL对象
        setTimeout(() => {
            URL.revokeObjectURL(url);
        }, 100);
    }

    // 获取当前日期函数
    function getCurrentDate() {
        const now = new Date();
        return now.toISOString().split('T')[0].replace(/-/g, '');
    }

    // 工具函数
    function getPaymentTypeText(type) {
        const types = {
            1: '现金', 2: '微信', 3: '支付宝', 4: '医保'
        };
        return types[type] || '未知';
    }

    function getPaymentStatusText(status) {
        const statuses = {
            0: '待支付', 1: '已支付', 2: '已退款'
        };
        return statuses[status] || '未知';
    }

    function getPaymentStatusClass(status) {
        const classes = {
            0: 'text-yellow-600',
            1: 'text-green-600',
            2: 'text-gray-600'
        };
        return classes[status] || 'text-gray-600';
    }

    function formatPrice(price) {
        if (!price && price !== 0) return '¥0.00';
        return '¥' + parseFloat(price).toFixed(2);
    }

    function formatDateTime(date) {
        if (!date) return '';
        return new Date(date).toLocaleString('zh-CN');
    }

    function showMessage(message, type = 'success') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        messageDiv.innerHTML = `
            <i class="fa ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-2"></i>
            ${message}
        `;
        document.body.appendChild(messageDiv);
        setTimeout(() => messageDiv.remove(), 3000);
    }
</script>
</body>
</html>